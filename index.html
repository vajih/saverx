<!doctype html>
<html lang="en">
<head>
  <!-- =========================================================
       SaveRx.ai — Homepage (v2 preview)
       SEO + Social optimized head
       ========================================================= -->
  <meta charset="utf-8" />
  <title>SaveRx.ai — Lower your out-of-pocket on prescriptions (Repatha, Ozempic, Wegovy, Mounjaro, Stelara, Trulicity, Otexla, Entresto)</title>

  <!-- Primary description (keep a single meta description) -->
  <meta name="description" content="Find official manufacturer savings (copay cards, coupons, assistance) for medications like Repatha, Ozempic, Wegovy, Mounjaro, and Stelara.">

  <!-- Open Graph -->
  <meta property="og:title" content="SaveRx.ai — Lower Your Out-of-Pocket" />
  <meta property="og:description" content="Find official savings and copay programs for top medications." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://saverx.ai/" />
  <meta property="og:site_name" content="SaveRx.ai" />
  <meta property="og:image" content="https://saverx.ai/assets/img/hero-1200.jpg" />
  <meta property="og:image:secure_url" content="https://saverx.ai/assets/img/hero-1200.jpg" />
  <meta property="og:image:alt" content="Save on prescriptions with official manufacturer programs" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="SaveRx.ai — Lower Your Out-of-Pocket" />
  <meta name="twitter:description" content="Find official savings and copay programs for top medications." />
  <meta name="twitter:image" content="https://saverx.ai/assets/img/hero-1200.jpg" />

  <!-- Robots + theme -->
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#1d4ed8" />

  <!-- Canonical -->
  <link rel="canonical" href="https://saverx.ai/" />

  <!-- i18n -->
  <link rel="alternate" href="https://saverx.ai/" hreflang="en-us" />
  <link rel="alternate" href="https://saverx.ai/" hreflang="x-default" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png" />

  <!-- Preconnects -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <!-- CSS (existing site CSS first, then v2 scoped CSS) -->
  <link rel="stylesheet" href="assets/styles.css?v=2025-10-03">
  <link rel="stylesheet" href="assets/css/tokens.css">
  <link rel="stylesheet" href="assets/css/components.css">

  <!-- Page-local styles for homepage search (mirrors /drugs) -->
  <style>
    .home-search { margin-top: 10px; }
    .home-search .search-bar {
      display:grid; gap:10px; grid-template-columns: 1fr auto; align-items:start;
      margin-top: 12px; background:#fff; border:1px solid #e6eaf2; border-radius:14px; padding:10px;
    }
    .home-search input[type="search"]{ width:100%; padding:12px 14px; border:1px solid #dbe3f1; border-radius:10px; font-size:16px; }
    .home-search .search-meta{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e6eaf2; border-radius:999px; background:#f8fafc; font-size:13px; color:#334155; }
    .chip .count{ font-weight:800; }
    .no-results{ display:none; margin-top:14px; padding:14px; border:1px dashed #e6eaf2; border-radius:12px; color:#64748b; }
    .no-results[aria-hidden="false"]{ display:block; }
    /* Guard: modal visibility (safe no-op if your CSS already covers it) */
    .modal[aria-hidden="true"]{ display:none; }
    .modal[aria-hidden="false"]{ display:block; }

/* ===== Mobile nav (hamburger) ===== */
.nav-toggle{display:none;}
.nav-toggle .bar{
  display:block;width:20px;height:2px;background:currentColor;margin:3px 0;
  transition:transform .2s ease, opacity .2s ease;
}

@media (max-width: 960px){
  .header .container{position:relative;}
  .nav-toggle{
    display:inline-grid;place-items:center;width:44px;height:44px;cursor:pointer;
    background:transparent;border:1px solid var(--border-weak, #e6eaf2);border-radius:10px;
  }
  .header .nav{
    position:absolute;top:calc(100% + 8px);right:0;
    background:var(--surface, #fff);
    border:1px solid var(--border-weak, #e6eaf2);border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    padding:12px;width:min(84vw,320px);
    display:none;flex-direction:column;gap:8px;
  }
  .header .nav.open{display:flex;}
  /* Animate icon to X when open */
  body.nav-open .nav-toggle .bar:nth-child(1){transform:translateY(5px) rotate(45deg)}
  body.nav-open .nav-toggle .bar:nth-child(2){opacity:0}
  body.nav-open .nav-toggle .bar:nth-child(3){transform:translateY(-5px) rotate(-45deg)}
}

@media (min-width: 961px){
  .header .nav{display:flex;}
}

/* Hide page scroll while an overlay is open = only one scrollbar */
/* Put this at the very end of your CSS */
html { overflow: hidden; height: 100%; }   /* hide the outer scrollbar */
body { overflow-y: auto; height: 100%; }   /* keep a single scrollbar on body */


/* ==== Home-only spacing (tight) ==== */
body.design-v2 .hero.section{
  padding-top: clamp(2px, 1vw, 6px);
  padding-bottom: clamp(4px, 1vw, 8px);
}
body.design-v2 .hero.section h1{
  margin-bottom: 4px;
  line-height: 1.10;
}
body.design-v2 .hero.section p{        /* “lower your out-of-pocket” line */
  margin-top: 6px;
  margin-bottom: 8px;
}

/* Featured block */
body.design-v2 #featured.section-pad{
  padding-top: clamp(8px, 1vw, 16px);
  padding-bottom: clamp(10px, 1vw, 20px);
}
body.design-v2 #featured .section-title{
  margin-top: 0;
  margin-bottom: 6px;
}
body.design-v2 #featured .home-search{  /* search area inside Featured */
  margin-top: 8px;
}
body.design-v2 #featured .search-bar{   /* shrink inner gap a touch */
  margin-top: 6px;
}

/* General: prevent headings from adding extra top gap when a section begins */
body.design-v2 section > :first-child{ margin-top: 0; }



  </style>

  <!-- JSON-LD: Organization -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "SaveRx.ai",
    "url": "https://saverx.ai/",
    "logo": "https://saverx.ai/assets/img/logo-512.png",
    "contactPoint": [{
      "@type": "ContactPoint",
      "email": "questions@saverx.ai",
      "contactType": "customer support",
      "areaServed": "US"
    }]
  }
  </script>

  <!-- JSON-LD: Website -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "SaveRx.ai",
    "url": "https://saverx.ai/"
  }
  </script>
</head>

<body class="design-v2">
  <!-- =======================
       Header / Primary Nav
       ======================= -->
  <header class="header">
    <div class="container inner">
      <a href="/" class="logo" aria-label="SaveRx.ai">
        <img src="assets/img/logo.svg" alt="SaveRx.ai" height="28">
      </a>

      <!-- NEW: Hamburger button -->
      <button class="nav-toggle" aria-expanded="false" aria-controls="primary-nav" aria-label="Menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>

      <!-- UPDATED: give the nav an id -->
      <nav id="primary-nav" class="nav">
        <a href="/about.html">About</a>
        <a href="/contact.html">Contact</a>
      </nav>
    </div>
  </header>


  <!-- Mobile drawer (kept for future use) -->
  <aside id="mobile-drawer" class="mobile-drawer" hidden>
    <div class="drawer-backdrop" data-close></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Mobile navigation">
      <button class="drawer-close" type="button" aria-label="Close" data-close>&times;</button>
      <nav class="drawer-nav">
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </aside>

  <!-- =======================
       Hero
       ======================= -->
  <section class="hero section">
    <div class="container hero-grid">
      <div>
        <span class="badge eyebrow">Lower your out-of-pocket</span>
        <h1>Find official <span style="color:var(--brand-700)">manufacturer savings</span> for your prescriptions</h1>
        <p>SaveRx.ai connects you directly to copay cards, coupons, and patient assistance for drugs like Repatha, Ozempic, Wegovy, Mounjaro, and more.</p>
        <div>
          <a href="#featured" class="btn btn-primary">Find savings</a>
          <a href="about.html" class="btn btn-outline">How it works</a>
        </div>
      </div>

      <figure class="hero-media">
        <img src="assets/img/hero-1200.jpg" alt="Patients saving on prescription costs">
      </figure>
    </div>
  </section>

  <!-- =======================
       Featured (Loader + Skeletons + Cards)
       Rendered live from Google Sheet via Apps Script
       ======================= -->
  <section id="featured" class="container section-pad loading" aria-busy="true" aria-labelledby="savings-heading">
    <h2 id="savings-heading" class="section-title">Search</h2>

    <!-- In-place search (borrowed from /drugs, tuned for homepage) -->
    <div class="home-search" role="search" aria-label="Search featured medications">
      <div class="search-bar">
        <input id="home-q" type="search" placeholder="Search by brand, generic, or manufacturer…" autocomplete="off" aria-label="Search drugs">
        <div class="search-meta">
          <span class="chip">Showing <span id="home-resultCount" class="count">0</span></span>
          <button id="home-clearBtn" class="btn btn-outline" type="button" aria-label="Clear search" hidden>Clear</button>
        </div>
      </div>
      <div id="home-no-results" class="no-results" aria-hidden="true">No matches. Try a shorter name or <a href="/drugs/">browse all drugs</a>.</div>
    </div>
    <br>
    <h2 id="savings-heading" class="section-title">Featured:</h2>

    <!-- AI scanning loader banner -->
    <div class="ai-loader" id="ai-loader" role="status" aria-live="polite">
      <span class="ai-dot"></span><span class="ai-dot"></span><span class="ai-dot"></span>
      <strong>Finding current prices & programs…</strong>
      <small>Checking coupons, copay cards, and manufacturer offers</small>
    </div>

    <!-- Skeleton placeholders (visible while data loads) -->
    <div class="cards" id="skeleton-cards">
      <article class="card skeleton" aria-hidden="true">
        <div class="sk-line sk-title"></div>
        <div class="sk-line"></div>
        <div class="sk-pill"></div>
      </article>
      <article class="card skeleton" aria-hidden="true">
        <div class="sk-line sk-title"></div>
        <div class="sk-line"></div>
        <div class="sk-pill"></div>
      </article>
      <article class="card skeleton" aria-hidden="true">
        <div class="sk-line sk-title"></div>
        <div class="sk-line"></div>
        <div class="sk-pill"></div>
      </article>
    </div>

    <!-- Real cards injected here -->
    <div id="featured-cards" class="cards" role="list" aria-live="polite"></div>

    <!-- Fallback text loader -->
    <div id="cards-loading" class="text-center muted small" aria-live="polite">
      Loading savings
    </div>

    <noscript>
      <p class="muted small">JavaScript is required to load the latest Featured savings.</p>
    </noscript>
  </section>

  <!-- =======================
       Request a medication + Newsletter CTA
       ======================= -->
  <section class="cta-band" aria-labelledby="ctaTitle">
    <div class="cta-wrap">
      <!-- Left: Medication alert -->
      <div class="cta-card">
        <h2 id="ctaTitle" class="cta-title">Don’t see your medication?</h2>
        <p class="cta-sub">Tell us the drug and your email — we’ll alert you when we add it.</p>

        <form class="form" id="med-alert-form">
          <div class="form-row">
            <label class="sr-only" for="drugName">Medication name</label>
            <input id="drugName" name="drug" class="input" type="text" placeholder="Medication name (e.g., Repatha)" required autocomplete="off">
          </div>
          <div class="form-row">
            <label class="sr-only" for="alertEmail">Email address</label>
            <input id="alertEmail" name="email" class="input" type="email" placeholder="you@example.com" required autocomplete="email">
          </div>
          <button class="btn" type="submit">Notify me</button>
          <p class="form-hint">We’ll email only when this medication goes live.</p>
          <p class="form-msg" id="alertMsg" role="status" aria-live="polite"></p>
        </form>
      </div>

      <!-- Right: Newsletter -->
      <div class="cta-card">
        <h3 class="cta-title">Good news for your inbox</h3>
        <p class="cta-sub">Savings tips and new programs as we add them.</p>

        <form class="form" id="newsletter-form">
          <div class="form-row">
            <label class="sr-only" for="newsEmail">Email address</label>
            <input id="newsEmail" name="email" class="input" type="email" placeholder="Email address" required autocomplete="email">
          </div>
          <button class="btn" type="submit">Subscribe</button>
          <p class="form-hint">1–2 emails/month. Unsubscribe anytime.</p>
          <p class="form-msg" id="newsMsg" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <div class="cta-contact">
      <p><strong>Contact us</strong><br>
        <a href="mailto:questions@saverx.ai">questions@saverx.ai</a>
      </p>
    </div>
  </section>

  <!-- =======================
       Footer
       ======================= -->
  <footer class="footer">
    <div class="container grid">
      <div>
        <a class="logo" href="/"><img src="assets/img/logo.svg" alt="SaveRx.ai" height="28"></a>
        <p class="muted" style="color:#cbd5e1; max-width:52ch; margin-top:var(--s-4)">
          SaveRx.ai links you to official manufacturer savings programs. We are not a pharmacy.
        </p>
      </div>
      <div>
        <h4 style="margin-top:0;color:#fff">Quick Links</h4>
        <div><a href="/">Home</a></div>
        <div><a href="/drugs/">Drugs</a></div>
        <div><a href="/list.html">Complete List</a></div>
        <div><a href="/about.html">About</a></div>
        <div><a href="/contact.html">Contact</a></div>
      </div>
      <div>
        <h4 style="margin-top:0;color:#fff">Legal</h4>
        <div><a href="/privacy.html">Privacy Policy</a></div>
        <div><a href="/terms.html">Terms of Service</a></div>
      </div>
      <div>
        <h4 style="margin-top:0;color:#fff">Newsletter</h4>
        <!-- Footer newsletter: note data-newsletter + .form-msg -->
        <form data-newsletter novalidate>
          <input
            type="email"
            name="email"
            placeholder="you@email.com"
            required
            autocomplete="email"
            style="width:100%;margin-bottom:var(--s-3);padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0">
          <button class="btn btn-primary" type="submit">Subscribe</button>
          <p class="form-msg" role="status" aria-live="polite"></p>
        </form>
        <small>By subscribing, you agree to receive emails from SaveRx.ai and partners.</small>
      </div>

    </div>

    <!-- Disclaimer strip -->
    <div class="footer-disclaimer">
      <div class="container">
        <small>
          SaveRx.ai is an independent educational platform that provides information about official manufacturer savings programs.
          We do not sell, distribute, or process prescriptions. All trademarks are property of their respective owners.
          Actual savings and eligibility vary by program.
        </small>
      </div>
    </div>
  </footer>

  <!-- =======================
       Config & Scripts
       ======================= -->

  <!-- Config for Apps Script -->
  <script>
    window.PAGE_CONFIG = {
      scriptUrl: "https://script.google.com/macros/s/AKfycbyPArHul2llNlpy2YIW9-4X1G6AQSLmYw9jPpUoGx_KdAhIwcR_-ebRme6b0EVk7znUDw/exec"
    };
  </script>

  <!-- Fallback: if assets/scripts.js didn't define renderFeaturedDrugs(),
       this provides a minimal loader that expects ?mode=featured -->
  <script>
    window.renderFeaturedDrugs = window.renderFeaturedDrugs || (async function defaultRenderFeaturedDrugs(feedUrl){
      const container = document.getElementById('featured-cards');
      const loadingEl = document.getElementById('cards-loading');
      try {
        const res = await fetch(feedUrl, { cache: 'no-cache' });
        const json = await res.json();
        const items = (json && json.items) || [];
        if (loadingEl) loadingEl.style.display = 'none';

        // Remove loader + skeletons, flip aria-busy
        document.getElementById('skeleton-cards')?.remove();
        document.getElementById('ai-loader')?.remove();
        const wrapper = document.getElementById('featured');
        if (wrapper) {
          wrapper.classList.remove('loading');
          wrapper.classList.add('loaded');
          wrapper.setAttribute('aria-busy','false');
        }

        if (!container) return;
        if (!items.length) {
          container.innerHTML = '<p class="muted small">No Featured medications configured yet.</p>';
          return;
        }

        const escape = s => (s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        container.innerHTML = items.map(item => {
          const brand = escape(item.name || '');
          const generic = escape(item.generic || '');
          const mfr = escape(item.manufacturer || '');
          const url = item.url || '#';
          const asLow = (item.as_low_as != null && !isNaN(Number(item.as_low_as)))
            ? `As low as $${Number(item.as_low_as).toLocaleString()}`
            : '';
          return `
            <article class="card drug-card" role="listitem"
                     data-brand="${brand}" data-generic="${generic}" data-manufacturer="${mfr}">
              <div class="card-body">
                <h3 class="drug-title">${brand}${generic ? ' ('+generic+')' : ''}</h3>
                <p class="drug-subtitle">${mfr}${asLow ? ' • ' + asLow : ''}</p>
                <a class="btn btn-primary get-card"
                   href="${url}"
                   data-drug="${brand}"
                   data-url="${url}">Get Savings</a>
              </div>
            </article>
          `;
        }).join('');
      } catch (err) {
        if (loadingEl) loadingEl.textContent = 'Could not load savings.';
        console.error('Featured load error:', err);
      }
    });
  </script>

  <!-- Email modal (HTML only; behavior in assets/scripts.js) -->
  <div id="email-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="emailModalTitle" aria-modal="true">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-panel" role="document">
      <button class="modal-close" type="button" aria-label="Close" data-close>&times;</button>

      <h2 id="emailModalTitle" class="modal-title">Get your savings card</h2>
      <p class="modal-sub">Enter your email and we’ll take you to the official savings page for <span id="modalDrugLabel">this medication</span>.</p>

      <form id="modal-lead-form">
        <!-- Honeypot (spam trap) -->
        <input type="text" name="website" class="hp" tabindex="-1" aria-hidden="true" />

        <label class="field">
          <span>Email</span>
          <input id="modal-email" name="email" type="email" inputmode="email" autocomplete="email" required placeholder="you@example.com" />
        </label>

        <!-- Filled by JS when user clicks a card -->
        <input type="hidden" name="drug" id="modal-drug" />
        <input type="hidden" name="source" value="SaveRx Home Modal" />
        <input type="hidden" name="useragent" id="modal-ua" />
        <input type="hidden" name="referrer" id="modal-ref" />

        <div class="modal-actions">
          <button id="modal-submit" class="btn btn-primary" type="submit">Continue</button>
        </div>

        <div id="modal-status" class="status" role="status" aria-live="polite"></div>
        <p class="microcopy">By continuing, you agree to our <a href="terms.html">Terms</a> & <a href="privacy.html">Privacy</a>.</p>
      </form>
    </div>
  </div>

  <!-- Main JS (handles modal, featured rendering, forms, etc.) -->
  <script defer src="assets/scripts.js?v=2025-10-06a"></script>

  <!-- Trigger Featured load (safe) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.renderFeaturedDrugs && window.PAGE_CONFIG?.scriptUrl) {
        window.renderFeaturedDrugs(window.PAGE_CONFIG.scriptUrl + '?mode=featured');
      }
    });
  </script>

  <!-- Homepage search wiring (filters whatever cards are rendered into #featured-cards) -->
  <script>
    (function(){
      "use strict";
      const $  = (s, r=document)=> r.querySelector(s);
      const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
      // Normalize + strip accents without requiring Unicode property escapes
      const strip = s => (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const norm  = s => strip(s).toLowerCase();

      const qEl = $('#home-q');
      const clearBtn = $('#home-clearBtn');
      const countEl = $('#home-resultCount');
      const grid = $('#featured-cards');
      const empty = $('#home-no-results');

      if(!qEl || !grid) return;

      let INDEX = [];

      function buildIndex(){
        INDEX = $$('.drug-card', grid).map(el=>{
          const brand = el.dataset.brand || $('.drug-title', el)?.textContent || '';
          const generic = el.dataset.generic || '';
          const mfr = el.dataset.manufacturer || $('.drug-subtitle', el)?.textContent || '';
          const hay = norm([brand, generic, mfr, el.textContent].join(' '));
          el.dataset.search = hay;
          return el;
        });
        updateCount();
      }

      function updateCount(){
        const visible = INDEX.filter(el=>!el.hidden).length;
        if(countEl) countEl.textContent = String(visible);
      }

      function applyFilter(term){
        const t = norm(term).trim();
        clearBtn && (clearBtn.hidden = !t);
        if(INDEX.length === 0) buildIndex();
        let shown = 0;
        INDEX.forEach(el=>{
          const hay = el.dataset.search || '';
          const match = t ? t.split(/\s+/).every(w=>hay.includes(w)) : true;
          el.hidden = !match;
          if(match) shown++;
        });
        if(countEl) countEl.textContent = String(shown);
        if(empty) empty.setAttribute('aria-hidden', String(shown>0));
      }

      // Observe async card injection (works with your external renderer)
      const obs = new MutationObserver(()=>{ buildIndex(); applyFilter(qEl.value); });
      obs.observe(grid, { childList: true });

      // Events
      qEl.addEventListener('input', ()=> applyFilter(qEl.value));
      clearBtn?.addEventListener('click', ()=>{ qEl.value=''; applyFilter(''); qEl.focus(); });

      // Hydrate from ?q=
      try{ const u = new URL(window.location.href); const q = u.searchParams.get('q'); if(q){ qEl.value = q; } }catch{}

      // First pass (in case cards already present)
      buildIndex();
      applyFilter(qEl.value);
    })();
  </script>

  <!-- Mobile floating CTA -->
  <div class="mobile-cta">
    <div class="inner container">
      <strong>Ready to save?</strong>
      <a class="btn btn-primary" href="#featured">Find savings</a>
    </div>
  </div>
  <script>
  (function(){
    const btn = document.querySelector('.nav-toggle');
    const nav = document.getElementById('primary-nav');
    if(!btn || !nav) return;
    function setOpen(isOpen){
      nav.classList.toggle('open', isOpen);
      document.body.classList.toggle('nav-open', isOpen);
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }
    btn.addEventListener('click', ()=> setOpen(!nav.classList.contains('open')));
    document.addEventListener('click', (e)=>{
      if(!nav.classList.contains('open')) return;
      if(!nav.contains(e.target) && !btn.contains(e.target)) setOpen(false);
    });
    window.addEventListener('resize', ()=>{ if(window.innerWidth >= 961) setOpen(false); });
  })();
</script>

<!-- Ask SaveRx widget -->
<div id="srx-overlay"></div>

<div id="saverx-chat" aria-live="polite">
  <button id="saverx-btn" aria-controls="saverx-panel" aria-expanded="false">
    Ask SaveRx
  </button>
  <div id="saverx-panel" hidden role="dialog" aria-label="Ask SaveRx">
    <div class="srx-header">
      <strong>Ask SaveRx</strong>
      <span class="srx-sub">Informational only — not medical advice</span>
      <button id="srx-close" aria-label="Close" 
        style="border:0;background:transparent;font-size:20px;line-height:1;cursor:pointer">
        ×
      </button>
    </div>
    <div id="srx-log"></div>
    <form id="srx-form" autocomplete="off">
      <input id="srx-input" type="text" placeholder="Ask about savings (e.g., Stelara copay)" required />
      <button type="submit">Send</button>
    </form>
  </div>
</div>

    <div id="srx-chips" aria-label="Quick suggestions">
      <button type="button" class="srx-chip" data-q="Find official savings for Ozempic">Ozempic savings</button>
      <button type="button" class="srx-chip" data-q="How do I get a Repatha copay card?">Repatha copay</button>
      <button type="button" class="srx-chip" data-q="What is a patient assistance program, and who qualifies?">What is PAP?</button>
</div>

  </div>
</div>

<!-- Markdown rendering libs -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>


<script>
const WORKER_URL = "https://saverx-chat-proxy.saverx.workers.dev/chat";

const btn = document.getElementById("saverx-btn");
const panel = document.getElementById("saverx-panel");
const form = document.getElementById("srx-form");
const input = document.getElementById("srx-input");
const log = document.getElementById("srx-log");
const overlay = document.getElementById("srx-overlay");
const closeBtn = document.getElementById("srx-close");



function openPanel() {
  panel.removeAttribute("hidden");
  btn.setAttribute("aria-expanded", "true");
  if (overlay) overlay.classList.add("show");
  // prevent body from scrolling behind the sheet
  document.body.style.overflow = "hidden";
  // focus input
  input.focus();
}

function closePanel() {
  panel.setAttribute("hidden", "");
  btn.setAttribute("aria-expanded", "false");
  if (overlay) overlay.classList.remove("show");
  document.body.style.overflow = "";
}



btn.addEventListener("click", () => {
  const closed = panel.hasAttribute("hidden");
  if (closed) openPanel(); else closePanel();
});
overlay?.addEventListener("click", closePanel);
closeBtn?.addEventListener("click", closePanel);

/* 👇 Step 5: Fix iOS keyboard shifting the panel 👇 */
if (window.visualViewport) {
  const onVVChange = () => {
    const vv = window.visualViewport;
    const kb = window.innerHeight - vv.height - vv.offsetTop;
    // Move the panel upward if keyboard is open
    panel.style.transform = kb > 0 ? `translateY(-${kb}px)` : "translateY(0)";
  };
  window.visualViewport.addEventListener("resize", onVVChange);
  window.visualViewport.addEventListener("scroll", onVVChange);
}

function append(role, text) {
  const div = document.createElement("div");
  div.className = `srx-msg ${role === "user" ? "srx-user" : "srx-assistant"}`;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const content = input.value.trim();
  if (!content) return;
  append("user", content);
  input.value = "";

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ messages: [{ role:"user", content }] })
  });

  if (!res.ok || !res.body) {
    let bodyText = "";
    try { bodyText = await res.text(); } catch {}
    console.error("SaveRx fetch failed", res.status, bodyText);
    append("assistant", `Sorry, I couldn’t reach the SaveRx assistant (HTTP ${res.status}).`);
    return;
  }

  // --- Stream the Responses API events and render text deltas ---
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  const assistantDiv = document.createElement("div");
  assistantDiv.className = "srx-msg";
  log.appendChild(assistantDiv);

  let sseBuffer = "";
  let mdBuffer = ""; // raw markdown text as it streams

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    sseBuffer += decoder.decode(value, { stream: true });

    const lines = sseBuffer.split("\n");
    sseBuffer = lines.pop() || "";

    for (const line of lines) {
      if (!line.startsWith("data:")) continue;
      const json = line.slice(5).trim();
      if (!json || json === "[DONE]") continue;

      let evt;
      try { evt = JSON.parse(json); } catch { continue; }

      if (evt.type === "response.output_text.delta" && typeof evt.delta === "string") {
        mdBuffer += evt.delta;

        // Render markdown → HTML → sanitize
        const html = DOMPurify.sanitize(marked.parse(mdBuffer));
        assistantDiv.innerHTML = html;
        log.scrollTop = log.scrollHeight;
      } else if (evt.type === "response.error" || evt.type === "error") {
        console.error("Responses API error:", evt);
        append("assistant", "Sorry, there was an error generating the response.");
      }
    }
  }
});
</script>



</body>
</html>
